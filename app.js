
const clamp=(x,min,max)=>Math.max(min,Math.min(max,x));
const TOKENS={tokenize(s){if(!s)return[];let t=s;const m=[",",".","!","?",";",":","(",")","\"","[","]"];for(const x of m)t=t.split(x).join(` ${x} `);return t.split(/\s+/).filter(Boolean)},detokenize(a){if(!a||!a.length)return"";let s=a.join(" ");s=s.replace(/ \./g,".").replace(/ ,/g,",").replace(/ !/g,"!").replace(/ \?/g,"?").replace(/ ;/g,";").replace(/ :/g,":").replace(/ \)/g,")").replace(/\( /g,"(").replace(/ \]/g,"]").replace(/\[ /g,"[").replace(/ \"/g,'"');s=s.replace(/(\w)\s+'\s+(\w)/g,"$1'$2").replace(/(\w)\s+’\s+(\w)/g,"$1’$2");return s},normalized(s){if(!s)return"";let t=s.normalize?s.normalize("NFKC"):s;t=t.replace(/[\u2018\u2019\u02BC\u2032]/g,"'").replace(/[\u201C\u201D]/g,'"').replace(/[\u2013\u2014]/g,"-");t=t.replace(/(\w)\s*'\s*(\w)/g,"$1'$2");t=t.replace(/\s+([.,!?;:%)\]\}])/g,"$1").replace(/([(\[\{])\s+/g,"$1");t=t.replace(/\u00A0/g," ").replace(/\s+/g," ").trim().toLowerCase();return t}};
const CSV={parse(t){const r=[];let i=0,f="",row=[],q=false;while(i<t.length){const c=t[i];if(c=='"'){if(q&&t[i+1]=='"'){f+='"';i+=2;continue}q=!q;i++;continue}if(c==","&&!q){row.push(f);f="";i++;continue}if((c=="\n"||c=="\r")&&!q){row.push(f);f="";if(row.length>1||row[0]!="")r.push(row);row=[];i++;if(c=="\r"&&t[i]=="\n")i++;continue}f+=c;i++}if(f.length||row.length){row.push(f);r.push(row)}if(!r.length)throw new Error("CSVが空です");return r}};

const Store={load(){this.problems=JSON.parse(localStorage.getItem("problems")||"null");this.history=JSON.parse(localStorage.getItem("history")||"null");this.apiKey=localStorage.getItem("apiKey")||"";this.delayJPEN=parseFloat(localStorage.getItem("delayJPEN")||"1.0");this.delayNextJP=parseFloat(localStorage.getItem("delayNextJP")||"2.0");this.ttsMode=localStorage.getItem("ttsMode")||"audio";this.ttsEndpoint=localStorage.getItem("ttsEndpoint")||"";this.repeatCount=parseInt(localStorage.getItem("repeatCount")||"1");this.baseVolume=parseFloat(localStorage.getItem("baseVolume")||"1.0");this.boostDb=parseInt(localStorage.getItem("boostDb")||"0");if(!this.problems){fetch("resources/builtin_problems.csv").then(r=>r.text()).then(txt=>{const rows=CSV.parse(txt),h=rows[0];const ji=h.indexOf("jp"),ei=h.indexOf("en");const out=[];for(let i=1;i<rows.length;i++){const c=rows[i];if(!c)continue;const jp=(c[ji]||"").trim(),en=(c[ei]||"").trim();if(jp&&en)out.push({id:crypto.randomUUID(),jp,en})}this.problems=out;this.saveProblems();UI.refreshProblems();Practice.pickRandom();});}else{UI.refreshProblems();Practice.pickRandom()}if(!this.history){this.history=[];this.saveHistory()}UI.setApiKey(this.apiKey);UI.initDelayControls(this.delayJPEN,this.delayNextJP);UI.initTTSMode(this.ttsMode,this.ttsEndpoint);UI.initAudioControls(this.repeatCount,this.baseVolume,this.boostDb);UI.refreshHistory()},saveProblems(){localStorage.setItem("problems",JSON.stringify(this.problems))},saveHistory(){localStorage.setItem("history",JSON.stringify(this.history))},saveApiKey(k){this.apiKey=k;localStorage.setItem("apiKey",k||"")},setDelayJPEN(v){this.delayJPEN=parseFloat(v)||1.0;localStorage.setItem("delayJPEN",this.delayJPEN)},setDelayNextJP(v){this.delayNextJP=parseFloat(v)||2.0;localStorage.setItem("delayNextJP",this.delayNextJP)},setTTSMode(m){this.ttsMode=m;localStorage.setItem("ttsMode",m)},setTTSEndpoint(u){this.ttsEndpoint=u.trim();localStorage.setItem("ttsEndpoint",this.ttsEndpoint)},setRepeatCount(n){this.repeatCount=parseInt(n)||1;localStorage.setItem("repeatCount",this.repeatCount)},setBaseVolume(v){this.baseVolume=parseFloat(v)||1;localStorage.setItem("baseVolume",this.baseVolume)},setBoostDb(db){this.boostDb=parseInt(db)||0;localStorage.setItem("boostDb",this.boostDb)}};

const WebSpeechTTS={cancel(){speechSynthesis.cancel()},async speak(text,lang){return new Promise(res=>{const u=new SpeechSynthesisUtterance(text);u.lang=lang;u.onend=()=>res();u.onerror=()=>res();speechSynthesis.speak(u)})}};
const TTS={cancel(){WebSpeechTTS.cancel()},wait(ms){return new Promise(r=>setTimeout(r,ms))},async speak(t,l){await WebSpeechTTS.speak(t,l)},async seqOnce(jp,en){await WebSpeechTTS.speak(jp,"ja-JP");await this.wait((Store.delayJPEN||1)*1000);await WebSpeechTTS.speak(en,"en-US")},async seqRepeat(jp,en,rep){rep=Math.max(1,Math.min(10,rep|0));for(let i=0;i<rep;i++){await this.seqOnce(jp,en);if(i<rep-1)await this.wait((Store.delayNextJP||2)*1000)}}};

const Practice={current:null,pool:[],answer:[],pickRandom(){if(!Store.problems||!Store.problems.length){UI.showNoProblems();return}this.current=Store.problems[Math.floor(Math.random()*Store.problems.length)];UI.setJP(this.current.jp);this.resetTokens();UI.clearResult()},setProblemById(id){const p=Store.problems.find(x=>x.id===id);if(!p)return;this.current=p;UI.setJP(p.jp);this.resetTokens();UI.clearResult();UI.switchTab("practice")},resetTokens(){this.pool=TOKENS.tokenize(this.current.en).sort(()=>Math.random()-0.5);this.answer=[];UI.renderPool(this.pool);UI.renderAnswer(this.answer)},undo(){if(this.answer.length){const t=this.answer.pop();this.pool.push(t);UI.renderPool(this.pool);UI.renderAnswer(this.answer)}},shuffle(){this.pool=this.pool.sort(()=>Math.random()-0.5);UI.renderPool(this.pool)},tapPool(i){const [t]=this.pool.splice(i,1);this.answer.push(t);UI.renderPool(this.pool);UI.renderAnswer(this.answer)},tapAnswer(i){const [t]=this.answer.splice(i,1);this.pool.push(t);UI.renderPool(this.pool);UI.renderAnswer(this.answer)},check(){const ans=TOKENS.detokenize(this.answer);const ok=TOKENS.normalized(ans)===TOKENS.normalized(this.current.en);Store.history=[{id:crypto.randomUUID(),problemID:this.current.id,timestamp:Date.now(),userAnswer:ans,correct:ok},...(Store.history||[])];Store.saveHistory();UI.showResult(ok,this.current.en);UI.refreshHistory();this.explain(ans,ok)},async explain(userEN,ok){UI.showExplaining(true);const key=Store.apiKey;if(!key){UI.setExplanation("（APIキー未設定のため解説はスキップ）");UI.showExplaining(false);return}try{const prompt=`日本文:${this.current.jp}\n正解:${this.current.en}\n解答:${userEN}\n語順の理由を日本語で簡潔に解説して`;const resp=await fetch("https://api.openai.com/v1/responses",{method:"POST",headers:{"Authorization":`Bearer ${key}`,"Content-Type":"application/json"},body:JSON.stringify({model:"gpt-4.1-mini",input:[{role:"user",content:prompt}],temperature:0.2})});if(!resp.ok)throw new Error(await resp.text());const data=await resp.json();let text="";if(data?.output?.content)text=data.output.content.map(c=>c.text||"").join("\n").trim();UI.setExplanation(text||"（解説なし）")}catch(e){UI.setExplanation("解説取得失敗: "+e.message)}finally{UI.showExplaining(false)}}};

const ListAuto={running:false,abort:false,ctx:null,stop(){this.abort=true;this.running=false;TTS.cancel();UI.clearPlaying()},async playItemsJPEN(items,container){this.abort=false;this.running=true;for(const it of items){if(this.abort)break;UI.setPlaying(container,it.id);const{jp,en}=it;if(!jp||!en)continue;await TTS.seqRepeat(jp,en,Store.repeatCount||1);if(this.abort)break;await TTS.wait((Store.delayNextJP||2)*1000)}this.running=false;UI.clearPlaying()}};

const UI={els:{},lastProblems:[],lastHistory:[],_playingEl:null,init(){document.querySelectorAll("nav button").forEach(btn=>{btn.addEventListener("click",()=>{document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));btn.classList.add("active");const tab=btn.dataset.tab;document.querySelectorAll(".tab").forEach(s=>s.classList.remove("active"));document.getElementById(tab).classList.add("active")})});this.els.jp=document.getElementById("jpText");this.els.pool=document.getElementById("tokenPool");this.els.ans=document.getElementById("answerArea");this.els.result=document.getElementById("result");this.els.explainWrap=document.getElementById("explanationWrap");this.els.explain=document.getElementById("explanation");document.getElementById("undoBtn").onclick=()=>Practice.undo();document.getElementById("resetBtn").onclick=()=>Practice.resetTokens();document.getElementById("shuffleBtn").onclick=()=>Practice.shuffle();document.getElementById("checkBtn").onclick=()=>Practice.check();document.getElementById("nextBtn").onclick=()=>Practice.pickRandom();document.getElementById("speakJPBtn").onclick=async()=>{ListAuto.stop();await TTS.speak(Practice.current.jp,"ja-JP")};document.getElementById("speakENBtn").onclick=async()=>{ListAuto.stop();await TTS.speak(Practice.current.en,"en-US")};document.getElementById("speakSeqBtn").onclick=async()=>{ListAuto.stop();await TTS.seqRepeat(Practice.current.jp,Practice.current.en,Store.repeatCount||1)};document.getElementById("stopSpeakBtn").onclick=()=>{ListAuto.stop()};this.els.problemsList=document.getElementById("problemsList");const pSearch=document.getElementById("problemSearch");pSearch.addEventListener("input",()=>this.refreshProblems(pSearch.value));document.getElementById("problemsPlayAllBtn").onclick=()=>{if(!this.lastProblems.length){alert("一覧が空です");return}ListAuto.playItemsJPEN(this.lastProblems,this.els.problemsList)};document.getElementById("problemsStopBtn").onclick=()=>ListAuto.stop();document.getElementById("csvBtn").onclick=()=>document.getElementById("csvInput").click();document.getElementById("csvInput").addEventListener("change",async e=>{const file=e.target.files?.[0];if(!file)return;const text=await file.text();try{const rows=CSV.parse(text),h=rows[0];const ji=h.indexOf("jp"),ei=h.indexOf("en");let added=0;let arr=Store.problems||[];for(let i=1;i<rows.length;i++){const c=rows[i];if(!c)continue;const jp=(c[ji]||"").trim(),en=(c[ei]||"").trim();if(!jp||!en)continue;arr.push({id:crypto.randomUUID(),jp,en});added++}Store.problems=arr;Store.saveProblems();alert(`インポート成功：${added}件追加`);this.refreshProblems(pSearch.value)}catch(err){alert("インポート失敗: "+err.message)}e.target.value=""});this.els.histList=document.getElementById("historyList");const histFilter=document.getElementById("histFilter");const histSearch=document.getElementById("histSearch");histFilter.addEventListener("change",()=>this.refreshHistory());histSearch.addEventListener("input",()=>this.refreshHistory());document.getElementById("historyPlayAllBtn").onclick=()=>{if(!this.lastHistory.length){alert("一覧が空です");return}ListAuto.playItemsJPEN(this.lastHistory,this.els.histList)};document.getElementById("historyStopBtn").onclick=()=>ListAuto.stop();const apiKey=document.getElementById("apiKey");document.getElementById("saveKeyBtn").onclick=()=>{Store.saveApiKey(apiKey.value.trim());alert("保存しました")};document.getElementById("deleteKeyBtn").onclick=()=>{Store.saveApiKey("");apiKey.value="";alert("削除しました")};const s1=document.getElementById("delayJPEN"),s2=document.getElementById("delayNextJP"),v1=document.getElementById("delayJPENVal"),v2=document.getElementById("delayNextJPVal");s1.addEventListener("input",()=>v1.textContent=s1.value+"s");s2.addEventListener("input",()=>v2.textContent=s2.value+"s");s1.addEventListener("change",()=>Store.setDelayJPEN(s1.value));s2.addEventListener("change",()=>Store.setDelayNextJP(s2.value));this.els.delayJPEN=s1;this.els.delayNextJP=s2;this.els.delayJPENVal=v1;this.els.delayNextJPVal=v2;document.querySelectorAll('input[name="ttsMode"]').forEach(r=>{r.addEventListener("change",()=>{Store.setTTSMode(r.value)})});const ih=document.getElementById("installHint");if(window.matchMedia("(display-mode: standalone)").matches){ih.classList.add("hidden")}else{ih.classList.remove("hidden");ih.onclick=()=>alert("共有ボタン→ホーム画面に追加")}if("serviceWorker"in navigator){window.addEventListener("load",()=>navigator.serviceWorker.register("sw.js"))}Store.load()},setJP(t){this.els.jp.textContent=t},renderPool(pool){this.els.pool.innerHTML="";pool.forEach((t,i)=>{const b=document.createElement("button");b.className="token";b.textContent=t;b.onclick=()=>Practice.tapPool(i);this.els.pool.appendChild(b)})},renderAnswer(ans){this.els.ans.innerHTML="";ans.forEach((t,i)=>{const b=document.createElement("button");b.className="token";b.textContent=t;b.onclick=()=>Practice.tapAnswer(i);this.els.ans.appendChild(b)})},showResult(ok,correctEN){this.els.result.className="result "+(ok?"ok":"ng");this.els.result.textContent=ok?"正解！":"不正解：正解は "+correctEN},clearResult(){this.els.result.className="result";this.els.result.textContent="";this.els.explainWrap.classList.add("hidden");this.els.explain.textContent=""},showExplaining(b){if(b){this.els.explainWrap.classList.remove("hidden");this.els.explain.textContent="解説を生成中…"}},setExplanation(t){this.els.explainWrap.classList.remove("hidden");this.els.explain.textContent=t||"（解説なし）"},refreshProblems(q=""){const key=(q||"").toLowerCase();const list=(Store.problems||[]).filter(p=>!key||p.jp.toLowerCase().includes(key)||p.en.toLowerCase().includes(key));this.lastProblems=list.map(p=>({jp:p.jp,en:p.en,id:p.id}));this.els.problemsList.innerHTML="";list.forEach(p=>{const d=document.createElement("div");d.className="item";d.dataset.id=p.id;d.innerHTML=`<div class="meta">ID:${p.id}</div><div>${p.jp}</div><div class="en">${p.en}</div>`;d.addEventListener("click",()=>Practice.setProblemById(p.id));this.els.problemsList.appendChild(d)})},refreshHistory(){const filter=document.getElementById("histFilter").value;const key=(document.getElementById("histSearch").value||"").toLowerCase();const base=Store.history||[];const filtered=base.filter(rec=>{if(filter==="correct"&&!rec.correct)return false;if(filter==="wrong"&&rec.correct)return false;return true});const list=filtered.filter(rec=>{if(!key)return true;const p=Store.problems.find(x=>x.id===rec.problemID);return (p?.jp||"").toLowerCase().includes(key)||(p?.en||"").toLowerCase().includes(key)||(rec.userAnswer||"").toLowerCase().includes(key)});this.els.histList.innerHTML="";this.lastHistory=[];list.forEach(rec=>{const p=Store.problems.find(x=>x.id===rec.problemID);const d=document.createElement("div");d.className="item";d.dataset.id=p?.id||"";const dt=new Date(rec.timestamp);const jp=p?.jp||"(削除済み問題)";const en=p?.en||"";if(p?.jp&&p?.en)this.lastHistory.push({jp:p.jp,en:p.en,id:p.id});d.innerHTML=`<div class="meta"><span>${rec.correct?"正解":"不正解"}</span><span>${dt.toLocaleDateString()} ${dt.toLocaleTimeString()}</span></div><div>${jp}</div><div class="ans">あなたの解答：${rec.userAnswer}</div><div class="en">正解：${en}</div>`;d.addEventListener("click",()=>{if(p?.id)Practice.setProblemById(p.id)});this.els.histList.appendChild(d)})},setPlaying(container,id){this.clearPlaying(container);if(!container)return;const el=container.querySelector(`.item[data-id="${CSS.escape(id)}"]`);if(el){el.classList.add("playing");el.scrollIntoView({behavior:"smooth",block:"center"});this._playingEl=el}},clearPlaying(container){if(container){container.querySelectorAll(".item.playing").forEach(x=>x.classList.remove("playing"))}else{document.querySelectorAll(".item.playing").forEach(x=>x.classList.remove("playing"))}this._playingEl=null},setApiKey(k){document.getElementById("apiKey").value=k||""},initDelayControls(d1,d2){document.getElementById("delayJPEN").value=d1;document.getElementById("delayNextJP").value=d2;document.getElementById("delayJPENVal").textContent=d1+"s";document.getElementById("delayNextJPVal").textContent=d2+"s"},initAudioControls(rep,vol,boost){document.getElementById("repeatCount").value=rep;document.getElementById("repeatCountVal").textContent=rep+"回";document.getElementById("baseVolume").value=vol;document.getElementById("baseVolumeVal").textContent=vol.toFixed(2);document.getElementById("boostDb").value=boost;document.getElementById("boostDbVal").textContent=boost+" dB"},initTTSMode(mode,endpoint){document.querySelectorAll('input[name="ttsMode"]').forEach(r=>{r.checked=(r.value===mode)});document.getElementById("ttsEndpoint").value=endpoint||""},showNoProblems(){this.setJP("（問題がありません。問題タブからCSVを追加してください）");this.renderPool([]);this.renderAnswer([])},switchTab(id){document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));document.querySelector(`nav button[data-tab="${id}"]`)?.classList.add("active");document.querySelectorAll(".tab").forEach(s=>s.classList.remove("active"));document.getElementById(id).classList.add("active")}};

window.addEventListener("DOMContentLoaded",()=>UI.init());
